<!-- src/app/componants/userhome/main-page/main-page.component.html -->

<div id="page-contents">
  <div class="container">
    <div class="row">

      <app-left-bar></app-left-bar>

      <div class="col-md-7">
        <app-publish></app-publish>

        <div *ngIf="loading" class="text-center p-2">Loading...</div>

        <!-- FEED -->
        <div class="post-content" *ngFor="let post of posts">

          <div class="post-container">
            <img
              [src]="fixImage(post.author?.profileImageUrl)"
              alt="user"
              class="profile-photo-md pull-left" />

            <div class="post-detail">

              <!-- Header -->
              <div class="user-info">
                <h5>
                  <a href="javascript:void(0)" class="profile-link">
                    {{ fullName(post.author) }}
                  </a>
                </h5>
                <p class="text-muted">{{ post.createdAt | date:'short' }}</p>
              </div>

              <!-- Reactions -->
              <div class="reaction">
                <a
                  class="btn text-green"
                  (click)="toggleLike(post)"
                  [class.active]="isLiked(post)">
                  <i class="icon ion-thumbsup"></i>
                  {{ likeCount(post) }}
                  <span *ngIf="isLiked(post)"> (You)</span>
                </a>

                <a
                  class="btn text-red"
                  (click)="toggleDislike(post)"
                  [class.active]="isDisliked(post)">
                  <i class="fa fa-thumbs-down"></i>
                  {{ dislikeCount(post) }}
                  <span *ngIf="isDisliked(post)"> (You)</span>
                </a>

                <a
                  class="btn text-muted"
                  style="margin-left:10px"
                  (click)="toggleComments(post)">
                  <i class="icon ion-chatboxes"></i>
                  {{ commentCount(post) }}
                </a>
              </div>

              <div class="line-divider"></div>

              <!-- Text -->
              <div class="post-text" *ngIf="post.text">
                <p>{{ post.text }}</p>
              </div>

              <!-- Media from post.media[] -->
              <div class="line-divider" *ngIf="hasMedia(post)"></div>

              <div *ngIf="hasMedia(post)">
                <ng-container *ngFor="let m of mediaItems(post)">

                  <img
                    *ngIf="isImageMedia(m)"
                    [src]="mediaItemUrl(m)"
                    alt="post-image"
                    class="img-responsive post-image" />

                  <video *ngIf="isVideoMedia(m)" class="post-video" controls>
                    <source [src]="mediaItemUrl(m)" type="video/mp4" />
                  </video>

                </ng-container>
              </div>

              <div class="line-divider"></div>

              <!-- Comments block -->
              <div *ngIf="post.commentsLoaded">

                <div *ngIf="post.loadingComments" class="text-center p-2">
                  Loading comments...
                </div>

                <div class="post-comment" *ngFor="let c of (post.comments || [])">
                  <img
                    [src]="fixImage(c.author?.profileImageUrl)"
                    alt=""
                    class="profile-photo-sm" />

                  <p>
                    <a href="javascript:void(0)" class="profile-link">
                      {{ fullName(c.author) }}
                    </a>
                    {{ c.content }}
                  </p>

                  <!-- Replies toggle -->
                  <div style="margin-left:44px;">
                    <a href="javascript:void(0)" (click)="toggleReplies(post, c)">
                      Replies
                    </a>

                    <span *ngIf="isRepliesLoading(post, c.id)"> - Loading...</span>

                    <div class="replies" *ngIf="isRepliesShown(post, c.id)">

                      <div *ngFor="let r of getReplies(post, c.id)" class="post-comment reply">
                        <img
                          [src]="fixImage(r.author?.profileImageUrl)"
                          alt=""
                          class="profile-photo-sm" />
                        <p>
                          <a href="javascript:void(0)" class="profile-link">
                            {{ fullName(r.author) }}
                          </a>
                          {{ r.content }}
                        </p>
                      </div>

                      <!-- Add reply -->
                      <div class="post-comment" style="margin-left:44px;">
                        <img [src]="meImage" alt="" class="profile-photo-sm" />
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Write a reply..."
                          [ngModel]="getReplyText(post, c.id)"
                          (ngModelChange)="setReplyText(post, c.id, $event)"
                          (keyup.enter)="addReply(post, c)" />
                      </div>

                    </div>
                  </div>
                </div>

              </div>

              <!-- Add comment -->
              <div class="post-comment">
                <img [src]="meImage" alt="" class="profile-photo-sm" />
                <input
                  type="text"
                  class="form-control"
                  placeholder="Post a comment"
                  [(ngModel)]="post.commentText"
                  (keyup.enter)="addComment(post)" />
              </div>

            </div>
          </div>
        </div>

        <div class="text-center" style="margin: 10px 0;">
          <button
            class="btn btn-default"
            (click)="loadMore()"
            [disabled]="loading || (page + 1 >= totalPages)">
            Load more
          </button>
        </div>

      </div>

      <app-right-bar></app-right-bar>

    </div>
  </div>
</div>
